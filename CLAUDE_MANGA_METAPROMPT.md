# 漫画生成：メタプロンプト構築の依頼

## 依頼内容
漫画生成API（`src/app/api/generate/manga/route.ts`）において、**年齢制御を強力に組み込んだメタプロンプト**を構築してください。

## 背景・問題
- ユーザーが抽象度の高い指示（例：「子供と大人が会話している」）を出しても、年齢が適切に区別されない
- 「子供も一緒に老けた」という問題が発生
- デフォルトで組み込まれるプロンプトが年齢制御に弱い

## 要件

### 1) メタプロンプトの役割
- ユーザーのプロンプトから年齢関連キーワードを自動検出
- 検出した場合も、しなくても、常に「年齢を適切に区別する」という強力な指示を生成
- 抽象度の高い指示でも、AIが適切に年齢を推測・維持できるようにする

### 2) 実装すべき機能

#### A) 年齢キーワード検出
以下の年齢層のキーワードを検出できるようにする：
- **子供（5-12歳）**: 子供、子ども、こども、幼児、小学生、少年、少女、男の子、女の子、kid, child, children, boy, girl
- **中高生（13-17歳）**: 中学生、中高生、ティーン、teen, teenager
- **大人（25-45歳）**: 大人、成人、女性、男性、お母さん、お父さん、母親、父親、adult, woman, man, mother, father, mom, dad
- **高齢者（60-80歳）**: おばあちゃん、おじいちゃん、高齢、elderly, grandmother, grandfather, grandma, grandpa

#### B) 年齢制御指示の生成
検出結果に応じて、以下のような年齢制御指示を生成：

**年齢キーワードが検出された場合:**
- 検出された年齢層を明示
- 各年齢層の具体的な特徴（顔立ち、体の大きさ、プロポーション、頭身比など）を指定
- 同じシーン内での年齢差を明確にする指示
- 年齢の混同を絶対に避ける指示

**年齢キーワードが検出されない場合:**
- 年齢制御の基本原則を提示
- 文脈から適切な年齢を推測する指示
- 年齢の区別ルールを明示

#### C) キャラクター参照画像がある場合の対応
- 参照画像の年齢を正確に維持する指示
- 参照画像とプロンプトの年齢指定が矛盾する場合の優先順位

### 3) プロンプト構造
生成されるプロンプトは以下の構造を持つこと：

```
あなたは漫画・イラスト生成の専門家です。以下の指示に従って高品質な漫画イラストを生成してください。

【スタイル指定】
（既存のSTYLE_PROMPTSから）

【カラーモード】
（既存のcolorInstructionから）

【アスペクト比】
（既存のaspectInstructionから）

【キャラクター参照】
（既存のcharRefInstructionから、年齢維持の指示も追加）

【キャラクター年齢の厳密な制御（最重要）】
（メタプロンプトで生成された年齢制御指示）

【ユーザーの指示】
（ユーザーが入力したprompt）

【重要】
- 高品質な漫画/アニメスタイルで描画
- 日本の漫画の表現技法を活用
- **キャラクターの年齢を厳密に守る（最重要・最優先）**
- 年齢の混同は絶対に避ける
- プロフェッショナルな仕上がり
```

### 4) 実装ファイル
- `src/app/api/generate/manga/route.ts`
- 既存のコードを尊重しつつ、メタプロンプト構築関数を追加
- 既存のプロンプト構築ロジック（行121-147あたり）を拡張

### 5) 期待される動作例

#### ケース1: 年齢キーワードが検出される場合
**ユーザープロンプト**: 「子供と大人が会話している」

**生成される指示**:
- 検出された年齢層: 子供（5-12歳）、大人（25-45歳）
- 具体的な年齢制御ルール（顔立ち、体の大きさ、プロポーションなど）
- 年齢差を明確にする指示

#### ケース2: 年齢キーワードが検出されない場合
**ユーザープロンプト**: 「2人が会話している」

**生成される指示**:
- 年齢制御の基本原則
- 文脈から適切な年齢を推測する指示
- 年齢の区別ルール（子供らしさ、大人らしさ）

#### ケース3: キャラクター参照画像がある場合
**追加指示**:
- 参照画像の年齢を正確に維持
- 参照画像とプロンプトの年齢指定が矛盾する場合の優先順位

## 受け入れ基準
- [ ] メタプロンプト構築関数が実装されている
- [ ] 年齢キーワードの検出が正確に動作する
- [ ] 検出された場合とされない場合の両方で、適切な年齢制御指示が生成される
- [ ] キャラクター参照画像がある場合の年齢維持指示が含まれる
- [ ] 生成されるプロンプトが、年齢制御を最優先事項として扱っている
- [ ] `npm run lint` エラー0
- [ ] 実際に生成した漫画で、子供と大人の年齢差が明確に見える

## 実装方針のヒント
- 関数名: `buildAgeControlInstruction(prompt: string): string` など
- 検出ロジック: キーワードマッチング（大文字小文字を区別しない）
- 指示生成: テンプレートリテラルを使用して、検出結果に応じた指示を動的に生成
- 既存コードとの統合: 既存の `fullPrompt` 構築ロジックに `ageControlInstruction` を挿入

## 注意事項
- 既存のコードスタイルを尊重する
- TypeScriptの型安全性を保つ
- パフォーマンスを考慮（不要な処理を避ける）
- コメントを適切に追加（メタプロンプトの意図を説明）

